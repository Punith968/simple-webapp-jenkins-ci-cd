// Jenkinsfile — Declarative pipeline for Simple WebApp CI/CD demo
pipeline {
  agent any

  // Environment variables (override in Jenkins configuration or pipeline parameters)
  environment {
    // Set REPO_URL in Jenkins credentials or pipeline environment if you want the pipeline to clone externally
    REPO_URL = ""
    DEPLOY_METHOD = "copy" // options: 'copy' or 'docker'
    IMAGE_NAME = "simple-webapp:latest"
    CONTAINER_NAME = "simple-webapp-demo"
    WEBAPP_PORT = "8090" // External port for accessing the webapp
    BIND_HOST = "0.0.0.0" // Bind address for user-space Python server
    // For S3 deploys (set these in Jenkins as appropriate)
    S3_BUCKET = ""        // e.g., my-unique-bucket-name
    AWS_REGION = "us-east-1"
  }

  stages {
    stage('Checkout') {
      steps {
        script {
          if (env.REPO_URL?.trim()) {
            echo "Cloning from ${env.REPO_URL} (branch: main)..."
            bat 'git clone --branch main %REPO_URL% repo || exit 0'
            dir('repo') { bat 'dir' }
          } else {
            echo 'REPO_URL not set — using current workspace contents.'
            bat 'cd && dir'
          }
        }
      }
    }

    stage('Build') {
      steps {
        dir('simple-webapp-jenkins-ci-cd') {
          echo 'Validating folder structure and required files...'
          bat 'validate.bat'
        }
      }
    }

    stage('Test') {
      steps {
        dir('simple-webapp-jenkins-ci-cd') {
          echo 'Running simple tests (file existence) — validate.bat'
          bat 'validate.bat'
        }
      }
    }

    stage('Deploy') {
      steps {
        dir('simple-webapp-jenkins-ci-cd') {
          script {
            if (env.DEPLOY_METHOD == 'docker') {
              echo "Docker deploy not supported on Windows in this pipeline."
            } else if (env.DEPLOY_METHOD == 's3') {
              echo "S3 deploy not supported on Windows in this pipeline."
            } else {
              echo 'Deploy method: copy — Windows batch deploy'
              bat 'deploy.bat'
            }
          }
        }
      }
    }
  }

  post {
    success {
      echo '================================================'
      echo 'Pipeline completed successfully! ✅'
      echo '================================================'
      script {
        if (env.DEPLOY_METHOD == 'docker') {
          echo "Webapp deployed and running at: http://localhost:${env.WEBAPP_PORT}"
          echo "Container name: ${env.CONTAINER_NAME}"
          sh "docker ps | grep ${env.CONTAINER_NAME} || echo 'Container not found'"
        }
      }
      echo '================================================'
      // Example: send email on success (requires email configured in Jenkins)
      // emailext subject: "Build Successful: ${env.JOB_NAME} #${env.BUILD_NUMBER}", body: "Good news!"
    }
    failure {
      echo 'Pipeline failed. Inspect logs and fix the issue.'
      // Optionally send failure notification
      // emailext subject: "Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}", body: "Something went wrong."
    }
  }
}
